---
title: '**First Part: COVID-19 in Spain**'
subtitle: '**Advanced Regression And Prediction**'
author: '*Roberto Jes√∫s Alcaraz Molina*'
date: "09/05/2021"
output:
  pdf_document:
    latex_engine: xelatex
    number_section: true
    highlight: tango
    fig_caption: yes
    toc: true
    # toc_depth: 4
header-includes: 
- \usepackage{float}
- \usepackage{amsbsy}
- \usepackage{amsmath}
- \usepackage{graphicx}
- \usepackage{subfig}
- \usepackage{booktabs}
bibliography: references.bib
---

```{=tex}
\begin{center}
\includegraphics[width=3in]{logouc3m}
\end{center}
```
\newpage

```{r include=FALSE}
knitr::opts_chunk$set(warning = FALSE, 
                      echo = F, 
                      message = FALSE,
                      eval = T,
                      fig.pos="H", 
                      fig.align="center",
                      fig.width=11,
                      cache=FALSE, error = TRUE)
```

```{r, echo = F}
# Model packages
pacman::p_load(ranger)

# Packages
# devtools::install_github("stevenpawley/recipeselectors")
pacman::p_load(COVID19, tidymodels, rsample, recipes, parsnip, 
               yardstick, workflows, tune, patchwork, lubridate, recipeselectors,
               doParallel, tidyquant, finetune, ggpubr, MASS, modeltime, timetk,
               stacks)
library(tidyverse, attach.required = T)
# For ggplot
theme_set(theme_tq())

spain <- readRDS("../00_data/spain.RDS")
# spain_new_data <- covid19(country = "spain", start = "2021-04-11", end = "2021-05-02")
```

```{r}
spain %>%
  plot_time_series(.date_var = date, deaths_week, .smooth = F)
```

```{r}
rfe_model <- rand_forest() %>%
  set_engine("ranger", importance = "permutation") %>%
  set_mode("regression")

# Predictive model for the deaths
set.seed(1234)
select_rec_deaths <- 
  recipe(deaths_week ~ ., data = spain) %>%
  step_rm(date) %>%
  step_select_vip(all_predictors(), outcome = "deaths_week", model = rfe_model, threshold = 0.2)

spain_deaths <- select_rec_deaths %>% prep() %>% juice()
spain_deaths <- spain_deaths %>%
  mutate(date = spain$date)

# Predictive model for the confirmed cases
select_rec_confirmed <- 
  recipe(confirmed_week ~ ., data = spain) %>%
  step_rm(date) %>%
  step_select_vip(all_predictors(), outcome = "confirmed_week", model = rfe_model, threshold = 0.2)


spain_confirmed <- select_rec_confirmed %>% prep() %>% juice()
spain_confirmed <- spain_confirmed%>%
  mutate(date = spain$date)
```




```{r}
set.seed(123)
spain_rolling_deaths <- rolling_origin(
  spain_deaths, 
  initial = 36, # number of weeks used to train in each resample
  assess = 3, # number of weeks used to validate in each resample
  cumulative = F,
  skip = 4
  )

spain_rolling_confirmed <- rolling_origin(
  spain_confirmed, 
  initial = 36, # number of weeks used to train in each resample
  assess = 3, # number of weeks used to validate in each resample
  cumulative = F,
  skip = 4
  )
```

```{r}
basic_rec_deaths <- 
  recipe(deaths_week ~ ., data = spain_deaths) %>%
  step_rm(date)

basic_rec_confirmed <- 
  recipe(confirmed_week ~ ., data = spain_confirmed) %>%
  step_rm(date)
```


# INTRODUCTION


# MACHINE LEARNING

```{r}
grid_ctrl <- control_grid(save_pred = T, save_workflow = T)

# KNN
kknn_model <- 
  nearest_neighbor(neighbors = tune(), weight_func = tune()) %>% 
  set_mode("regression") %>% 
  set_engine("kknn") 

# SVM
svm_poly_model <-
  svm_poly(cost = tune(), degree = tune(), scale_factor = tune(), margin = tune()) %>%
  set_engine('kernlab') %>%
  set_mode('regression')

svm_rbf_model <-
  svm_rbf(cost = tune(), rbf_sigma = tune(), margin = tune()) %>%
  set_engine('kernlab') %>%
  set_mode('regression')

# Decision tree
dec_tree_model <-
  decision_tree(tree_depth = tune(), min_n = tune(), cost_complexity = tune()) %>%
  set_engine('rpart') %>%
  set_mode('regression')

# RF
ranger_model <- 
  rand_forest(mtry = tune(), min_n = tune(), trees = tune()) %>% 
  set_mode("regression") %>% 
  set_engine("ranger") 

# NN
mlp_model <-
  mlp(hidden_units = tune(), penalty = tune(), epochs = tune()) %>%
  set_engine('nnet') %>%
  set_mode('regression')
```


## KNN

```{r}
# Deaths
kknn_deaths_rec <- 
  basic_rec_deaths %>%
  step_corr(all_numeric_predictors(), threshold = 0.65) %>% # decorrelate predictors
  step_dummy(all_nominal(), -all_outcomes()) %>% 
  step_zv(all_predictors()) %>% 
  step_normalize(all_predictors(), -all_nominal())

# Confirmed
kknn_confirmed_rec <- 
  basic_rec_confirmed %>% 
  step_corr(all_numeric_predictors(), threshold = 0.65) %>% # decorrelate predictors
  step_dummy(all_nominal(), -all_outcomes()) %>% 
  step_zv(all_predictors()) %>% 
  step_normalize(all_predictors(), -all_nominal())
```


## SVR

```{r}
# Deaths
svm_deaths_rec <-
  basic_rec_deaths %>% 
  step_corr(all_numeric_predictors(), threshold = 0.65) %>% # decorrelate predictors
  step_dummy(all_nominal(), -all_outcomes()) %>% 
  step_zv(all_predictors()) %>% 
  step_normalize(all_predictors(), -all_nominal()) 

# Confirmed
svm_confirmed_rec <-
  basic_rec_confirmed %>% 
  step_corr(all_numeric_predictors(), threshold = 0.65) %>% # decorrelate predictors
  step_dummy(all_nominal(), -all_outcomes()) %>% 
  step_zv(all_predictors()) %>% 
  step_normalize(all_predictors(), -all_nominal()) 
```


## Regression Trees and Random Forest

```{r}
# Deaths
dec_tree_deaths_rec <- 
  basic_rec_deaths

# Confirmed
dec_tree_confirmed_rec <- 
  basic_rec_confirmed
```


```{r}
# Deaths
ranger_deaths_rec <- 
  basic_rec_deaths

# Confirmed
ranger_confirmed_rec <- 
  basic_rec_confirmed
```


## NN

```{r}
# Deaths
mlp_deaths_rec <-
  basic_rec_deaths %>% 
  step_corr(all_numeric_predictors(), threshold = 0.65) %>% # decorrelate predictors
  step_dummy(all_nominal(), -all_outcomes()) %>% 
  step_zv(all_predictors()) %>% 
  step_normalize(all_predictors(), -all_nominal())

# Confirmed
mlp_confirmed_rec <-
  basic_rec_confirmed %>% 
  step_corr(all_numeric_predictors(), threshold = 0.65) %>% # decorrelate predictors
  step_dummy(all_nominal(), -all_outcomes()) %>% 
  step_zv(all_predictors()) %>% 
  step_normalize(all_predictors(), -all_nominal())
```

```{r}
# Deaths
workflow_tune_deaths <- workflow_set(
  
  preproc = list(
    kknn_deaths = kknn_deaths_rec,
    svm_poly_deaths = svm_deaths_rec,
    svm_rbf_deaths = svm_deaths_rec,
    dec_tree_deaths = dec_tree_deaths_rec,
    ranger_deaths = ranger_deaths_rec,
    mlp_deaths = mlp_deaths_rec
  ),
  
  models = list(
    wf_1 = kknn_model,
    wf_2 = svm_poly_model,
    wf_3 = svm_rbf_model,
    wf_4 = dec_tree_model,
    wf_5 = ranger_model,
    wf_6 = mlp_model
  ), 
  
  cross = F
)


workflow_tune_confirmed <- workflow_set(
  
  preproc = list(
    kknn_confirmed = kknn_confirmed_rec,
    svm_poly_confirmed = svm_confirmed_rec,
    svm_rbf_confirmed = svm_confirmed_rec,
    dec_tree_confirmed = dec_tree_confirmed_rec,
    ranger_confirmed = ranger_confirmed_rec,
    mlp_confirmed = mlp_confirmed_rec
  ),
  
  models = list(
    wf_1 = kknn_model,
    wf_2 = svm_poly_model,
    wf_3 = svm_rbf_model,
    wf_4 = dec_tree_model,
    wf_5 = ranger_model,
    wf_6 = mlp_model
  ), 
  
  cross = F
)
```


### DEATHS
```{r}
cl <- makePSOCKcluster(8)
registerDoParallel(cl)

grid_ctrl <-
   control_grid(
      save_pred = TRUE,
      save_workflow = TRUE
   )

workflow_results_deaths <- workflow_tune_deaths %>%
  workflow_map(
    seed = 1503,
    resamples = spain_rolling_deaths,
    grid = 50,
    control = grid_ctrl,
    verbose = T
   )

stopCluster(cl)
```

```{r}
autoplot(workflow_results_deaths, select_best = T) +
  ggtitle("Results for the deaths model") +
  scale_color_tq() +
  theme_tq()
```

```{r}
# workflow_results_deaths %>%
#   pull_workflow_set_result("mlp_deaths_wf_6") %>%
#   pull(.notes)
# 
# workflow_results_deaths %>%
#   pull_workflow_set_result("mlp_deaths_wf_6") %>%
#   collect_metrics() %>%
#   filter(.metric == "rmse") %>%
#   arrange(mean) %>%
#   head(5)
# 
# workflow_results_deaths %>%
#   pull_workflow_set_result("mlp_deaths_wf_6") %>%
#   collect_metrics() %>%
#   filter(.metric == "rsq") %>%
#   arrange(desc(mean)) %>%
#   head(5)

kknn_param <- kknn_model %>%
  parameters() %>%
  update(neighbors = neighbors(c(3, 21)))

svm_poly_param <- svm_poly_model %>%
  parameters() %>%
  update(cost = cost(c(-10, 3.5)),
         scale_factor = scale_factor(c(-10, -3)))

svm_rbf_param <- svm_rbf_model %>%
  parameters() %>%
  update(cost = cost(c(0,5)),
         rbf_sigma = rbf_sigma(c(-10, -2)))

dec_tree_param <- dec_tree_model %>%
  parameters() %>%
  update(cost_complexity = cost_complexity(c(-10, -5)),
         tree_depth = tree_depth(c(1, 30)), 
         min_n = min_n(c(2, 36))) 

ranger_param <- ranger_model %>%
  parameters() %>%
  update(mtry = mtry(c(2, 15)),
         trees = trees(c(200, 2000)),
         min_n = min_n(c(2, 36)))

mlp_param <- mlp_model %>%
  parameters() %>%
  update(hidden_units = hidden_units(c(2, 8)),
         penalty = penalty(c(-10, -5)),
         epochs = epochs(c(200, 1000)))

workflow_tune_deaths <- workflow_tune_deaths %>%
  option_add(param_info = kknn_param, 
             id = "kknn_deaths_wf_1") %>%
  option_add(param_info = svm_poly_param, 
             id = "svm_poly_deaths_wf_2") %>%
  option_add(param_info = svm_rbf_param, 
             id = "svm_rbf_deaths_wf_3") %>%
  option_add(param_info = dec_tree_param,
             id = "dec_tree_deaths_wf_4") %>%
  option_add(param_info = ranger_param,
             id = "ranger_deaths_wf_5") %>%
  option_add(param_info = mlp_param, 
             id = "mlp_deaths_wf_6")
```

```{r}
cl <- makePSOCKcluster(8)
registerDoParallel(cl)

grid_ctrl <-
   control_grid(
      save_pred = TRUE,
      save_workflow = TRUE
   )

workflow_results_deaths <- workflow_tune_deaths %>%
  workflow_map(
    seed = 1503,
    resamples = spain_rolling_deaths,
    grid = 100,
    control = grid_ctrl,
    verbose = T
   )

# i 1 of 6 tuning:     kknn_deaths_wf_1
# v 1 of 6 tuning:     kknn_deaths_wf_1 (14.4s)
# i 2 of 6 tuning:     svm_poly_deaths_wf_2
# v 2 of 6 tuning:     svm_poly_deaths_wf_2 (1m 5.4s)
# i 3 of 6 tuning:     svm_rbf_deaths_wf_3
# v 3 of 6 tuning:     svm_rbf_deaths_wf_3 (1m 6.8s)
# i 4 of 6 tuning:     dec_tree_deaths_wf_4
# v 4 of 6 tuning:     dec_tree_deaths_wf_4 (1m 3.7s)
# i 5 of 6 tuning:     ranger_deaths_wf_5
# v 5 of 6 tuning:     ranger_deaths_wf_5 (1m 10.2s)
# i 6 of 6 tuning:     mlp_deaths_wf_6
# v 6 of 6 tuning:     mlp_deaths_wf_6 (1m 8s)

stopCluster(cl)
```

```{r}
autoplot(workflow_results_deaths, select_best = T) +
  ggtitle("Results for the deaths model") +
  scale_color_tq() +
  theme_tq()

workflow_results_deaths %>%
  pull_workflow_set_result("dec_tree_deaths_wf_4") %>%
  collect_metrics() %>%
  filter(.metric == "rmse") %>%
  arrange(mean) %>%
  head(5)

workflow_results_deaths %>%
  pull_workflow_set_result("dec_tree_deaths_wf_4") %>%
  collect_metrics() %>%
  filter(.metric == "rsq") %>%
  arrange(desc(mean)) %>%
  head(5)
```

```{r}
workflow_results_deaths %>%
   pull_workflow_set_result("dec_tree_deaths_wf_4") %>%
   pull(.notes)
```

```{r}
kknn_deaths_res <- workflow_results_deaths %>%
   pull_workflow_set_result("kknn_deaths_wf_1")
svm_poly_deaths_res <- workflow_results_deaths %>%
   pull_workflow_set_result("svm_poly_deaths_wf_2")
svm_rbf_deaths_res <- workflow_results_deaths %>%
   pull_workflow_set_result("svm_rbf_deaths_wf_3")
dec_tree_deaths_res <- workflow_results_deaths %>%
   pull_workflow_set_result("dec_tree_deaths_wf_4")
ranger_deaths_res <- workflow_results_deaths %>%
   pull_workflow_set_result("ranger_deaths_wf_5")
mlp_deaths_res <- workflow_results_deaths %>%
   pull_workflow_set_result("mlp_deaths_wf_6")
```

```{r}
deaths_stack_data <- stacks() %>%
  add_candidates(kknn_deaths_res) %>%
  add_candidates(svm_poly_deaths_res) %>%
  add_candidates(svm_rbf_deaths_res) %>%
  add_candidates(dec_tree_deaths_res) %>%
  add_candidates(ranger_deaths_res) %>%
  add_candidates(mlp_deaths_res)

as_tibble(deaths_stack_data)
```

```{r}
cl <- makePSOCKcluster(8)
registerDoParallel(cl)

deaths_stack_model <- 
  deaths_stack_data %>%
  blend_predictions()

stopCluster(cl)
```

```{r}
autoplot(deaths_stack_model, type = "weights")
```

```{r}
cl <- makePSOCKcluster(8)
registerDoParallel(cl)

deaths_stack_model_fit <-
  deaths_stack_model %>%
  fit_members()

stopCluster(cl)
```

```{r}
summary(spain)
```




### CONFIRMED

```{r}
grid_ctrl <- control_grid(save_pred = T, save_workflow = T)

# KNN
kknn_model <- 
  nearest_neighbor(neighbors = tune(), weight_func = tune()) %>% 
  set_mode("regression") %>% 
  set_engine("kknn") 

# SVM
svm_poly_model <-
  svm_poly(cost = tune(), degree = tune(), scale_factor = tune(), margin = tune()) %>%
  set_engine('kernlab') %>%
  set_mode('regression')

svm_rbf_model <-
  svm_rbf(cost = tune(), rbf_sigma = tune(), margin = tune()) %>%
  set_engine('kernlab') %>%
  set_mode('regression')

# Decision tree
dec_tree_model <-
  decision_tree(tree_depth = tune(), min_n = tune(), cost_complexity = tune()) %>%
  set_engine('rpart') %>%
  set_mode('regression')

# RF
ranger_model <- 
  rand_forest(mtry = tune(), min_n = tune(), trees = tune()) %>% 
  set_mode("regression") %>% 
  set_engine("ranger") 

# NN
mlp_model <-
  mlp(hidden_units = tune(), penalty = tune(), epochs = tune()) %>%
  set_engine('nnet') %>%
  set_mode('regression')
```


```{r}
cl <- makePSOCKcluster(8)
registerDoParallel(cl)

grid_ctrl <-
   control_grid(
      save_pred = TRUE,
      save_workflow = TRUE
   )

workflow_results_deaths <- workflow_tune_deaths %>%
  workflow_map(
    seed = 1503,
    resamples = spain_rolling_deaths,
    grid = 50,
    control = grid_ctrl,
    verbose = T
   )

stopCluster(cl)
```

```{r}
autoplot(workflow_results_deaths, select_best = T) +
  ggtitle("Results for the deaths model") +
  scale_color_tq() +
  theme_tq()
```

```{r}
# workflow_results_deaths %>%
#   pull_workflow_set_result("mlp_deaths_wf_6") %>%
#   pull(.notes)
# 
# workflow_results_deaths %>%
#   pull_workflow_set_result("mlp_deaths_wf_6") %>%
#   collect_metrics() %>%
#   filter(.metric == "rmse") %>%
#   arrange(mean) %>%
#   head(5)
# 
# workflow_results_deaths %>%
#   pull_workflow_set_result("mlp_deaths_wf_6") %>%
#   collect_metrics() %>%
#   filter(.metric == "rsq") %>%
#   arrange(desc(mean)) %>%
#   head(5)

kknn_param <- kknn_model %>%
  parameters() %>%
  update(neighbors = neighbors(c(3, 21)))

svm_poly_param <- svm_poly_model %>%
  parameters() %>%
  update(cost = cost(c(-10, 3.5)),
         scale_factor = scale_factor(c(-10, -3)))

svm_rbf_param <- svm_rbf_model %>%
  parameters() %>%
  update(cost = cost(c(0,5)),
         rbf_sigma = rbf_sigma(c(-10, -2)))

dec_tree_param <- dec_tree_model %>%
  parameters() %>%
  update(tree_depth = tree_depth(), 
         min_n = min_n(c(2, 36))) 

ranger_param <- ranger_model %>%
  parameters() %>%
  update(mtry = mtry(c(2, 15)),
         trees = trees(c(200, 2000)),
         min_n = min_n(c(2, 36)))

mlp_param <- mlp_model %>%
  parameters() %>%
  update(hidden_units = hidden_units(c(2, 8)),
         penalty = penalty(c(-10, -5)),
         epochs = epochs(c(200, 1000)))

workflow_tune_deaths <- workflow_tune_deaths %>%
  option_add(param_info = kknn_param, 
             id = "kknn_deaths_wf_1") %>%
  option_add(param_info = svm_poly_param, 
             id = "svm_poly_deaths_wf_2") %>%
  option_add(param_info = svm_rbf_param, 
             id = "svm_rbf_deaths_wf_3") %>%
  option_add(param_info = dec_tree_param,
             id = "dec_tree_deaths_wf_4") %>%
  option_add(param_info = ranger_param,
             id = "ranger_deaths_wf_5") %>%
  option_add(param_info = mlp_param, 
             id = "mlp_deaths_wf_6")
```

```{r}
cl <- makePSOCKcluster(8)
registerDoParallel(cl)

grid_ctrl <-
   control_grid(
      save_pred = TRUE,
      save_workflow = TRUE
   )

workflow_results_deaths <- workflow_tune_deaths %>%
  workflow_map(
    seed = 1503,
    resamples = spain_rolling_deaths,
    grid = 100,
    control = grid_ctrl,
    verbose = T
   )

stopCluster(cl)
```




# STACKING ENSEMBLE


# REFERENCES



