---
title: '**First Part: COVID-19 in Spain**'
subtitle: '**Advanced Regression And Prediction**'
author: '*Roberto Jes√∫s Alcaraz Molina*'
date: "09/05/2021"
output:
  pdf_document:
    latex_engine: xelatex
    number_section: true
    highlight: tango
    fig_caption: yes
    toc: true
    # toc_depth: 4
header-includes: 
- \usepackage{float}
- \usepackage{amsbsy}
- \usepackage{amsmath}
- \usepackage{graphicx}
- \usepackage{subfig}
- \usepackage{booktabs}
bibliography: references.bib
---

```{=tex}
\begin{center}
\includegraphics[width=3in]{logouc3m}
\end{center}
```
\newpage

```{r include=FALSE}
knitr::opts_chunk$set(warning = FALSE, 
                      echo = F, 
                      message = FALSE,
                      eval = T,
                      fig.pos="H", 
                      fig.align="center",
                      fig.width=11,
                      cache=FALSE, error = TRUE)
```

```{r, echo = F}
# Model packages
pacman::p_load(ranger)

# Packages
# devtools::install_github("stevenpawley/recipeselectors")
pacman::p_load(COVID19, tidymodels, rsample, recipes, parsnip, 
               yardstick, workflows, tune, patchwork, lubridate, recipeselectors,
               doParallel, tidyquant, finetune, ggpubr, MASS, modeltime, timetk)
library(tidyverse, attach.required = T)
# For ggplot
theme_set(theme_tq())

spain <- readRDS("../00_data/spain.RDS")
# spain_new_data <- covid19(country = "spain", start = "2021-04-11", end = "2021-05-02")
```

```{r}
spain %>%
  plot_time_series(.date_var = date, deaths_week, .smooth = F)
```

```{r}
rfe_model <- rand_forest() %>%
  set_engine("ranger", importance = "permutation") %>%
  set_mode("regression")

# Predictive model for the deaths
set.seed(1234)
select_rec_deaths <- 
  recipe(deaths_week ~ ., data = spain) %>%
  step_rm(date) %>%
  step_select_vip(all_predictors(), outcome = "deaths_week", model = rfe_model, threshold = 0.2)

spain_deaths <- select_rec_deaths %>% prep() %>% juice()
spain_deaths <- spain_deaths %>%
  mutate(date = spain$date)

# Predictive model for the confirmed cases
select_rec_confirmed <- 
  recipe(confirmed_week ~ ., data = spain) %>%
  step_rm(date) %>%
  step_select_vip(all_predictors(), outcome = "confirmed_week", model = rfe_model, threshold = 0.2)


spain_confirmed <- select_rec_confirmed %>% prep() %>% juice()
spain_confirmed <- spain_confirmed%>%
  mutate(date = spain$date)
```




```{r}
set.seed(123)
spain_rolling_deaths <- rolling_origin(
  spain_deaths, 
  initial = 36, # number of weeks used to train in each resample
  assess = 3, # number of weeks used to validate in each resample
  cumulative = F,
  skip = 4
  )

spain_rolling_confirmed <- rolling_origin(
  spain_confirmed, 
  initial = 36, # number of weeks used to train in each resample
  assess = 3, # number of weeks used to validate in each resample
  cumulative = F,
  skip = 4
  )
```

```{r}
basic_rec_deaths <- 
  recipe(deaths_week ~ ., data = spain_deaths) %>%
  step_rm(date)

basic_rec_confirmed <- 
  recipe(confirmed_week ~ ., data = spain_confirmed) %>%
  step_rm(date)
```


# INTRODUCTION


# MACHINE LEARNING

```{r}
grid_ctrl <- control_grid(save_pred = T, save_workflow = T)

# KNN
kknn_model <- 
  nearest_neighbor(neighbors = tune(), weight_func = tune()) %>% 
  set_mode("regression") %>% 
  set_engine("kknn") 

# SVM
svm_poly_model <-
  svm_poly(cost = tune(), degree = tune(), scale_factor = tune(), margin = tune()) %>%
  set_engine('kernlab') %>%
  set_mode('regression')

svm_rbf_model <-
  svm_rbf(cost = tune(), rbf_sigma = tune(), margin = tune()) %>%
  set_engine('kernlab') %>%
  set_mode('regression')

# Decision tree
dec_tree_model <-
  decision_tree(tree_depth = tune(), min_n = tune(), cost_complexity = tune()) %>%
  set_engine('rpart') %>%
  set_mode('regression')

# RF
ranger_model <- 
  rand_forest(mtry = tune(), min_n = tune(), trees = tune()) %>% 
  set_mode("regression") %>% 
  set_engine("ranger") 

# NN
mlp_keras_model <-
  mlp(hidden_units = tune(), epochs = tune(), activation = tune()) %>%
  set_engine('keras') %>%
  set_mode('regression')

# Prophet
prophet_model <-
  modeltime::prophet_reg(growth = tune(), season = tune(), prior_scale_changepoints = tune(), prior_scale_seasonality = tune(), prior_scale_holidays = tune()) %>%
  set_engine('prophet')
```


## KNN

```{r}
# Deaths
kknn_deaths_rec <- 
  basic_rec_deaths %>%
  step_corr(all_numeric_predictors(), threshold = 0.65) %>% # decorrelate predictors
  step_dummy(all_nominal(), -all_outcomes()) %>% 
  step_zv(all_predictors()) %>% 
  step_normalize(all_predictors(), -all_nominal())

# Confirmed
kknn_confirmed_rec <- 
  basic_rec_confirmed %>% 
  step_corr(all_numeric_predictors(), threshold = 0.65) %>% # decorrelate predictors
  step_dummy(all_nominal(), -all_outcomes()) %>% 
  step_zv(all_predictors()) %>% 
  step_normalize(all_predictors(), -all_nominal())
```


## SVR

```{r}
# Deaths
svm_deaths_rec <-
  basic_rec_deaths %>% 
  step_corr(all_numeric_predictors(), threshold = 0.65) %>% # decorrelate predictors
  step_dummy(all_nominal(), -all_outcomes()) %>% 
  step_zv(all_predictors()) %>% 
  step_normalize(all_predictors(), -all_nominal()) 

# Confirmed
svm_confirmed_rec <-
  basic_rec_confirmed %>% 
  step_corr(all_numeric_predictors(), threshold = 0.65) %>% # decorrelate predictors
  step_dummy(all_nominal(), -all_outcomes()) %>% 
  step_zv(all_predictors()) %>% 
  step_normalize(all_predictors(), -all_nominal()) 
```


## Regression Trees and Random Forest

```{r}
# Deaths
dec_tree_deaths_rec <- 
  basic_rec_deaths

# Confirmed
dec_tree_confirmed_rec <- 
  basic_rec_confirmed
```


```{r}
# Deaths
ranger_deaths_rec <- 
  basic_rec_deaths

# Confirmed
ranger_confirmed_rec <- 
  basic_rec_confirmed
```


## NN

```{r}
# Deaths
mlp_deaths_rec <-
  basic_rec_deaths %>% 
  step_corr(all_numeric_predictors(), threshold = 0.65) %>% # decorrelate predictors
  step_dummy(all_nominal(), -all_outcomes()) %>% 
  step_zv(all_predictors()) %>% 
  step_normalize(all_predictors(), -all_nominal())

# Confirmed
mlp_confirmed_rec <-
  basic_rec_confirmed %>% 
  step_corr(all_numeric_predictors(), threshold = 0.65) %>% # decorrelate predictors
  step_dummy(all_nominal(), -all_outcomes()) %>% 
  step_zv(all_predictors()) %>% 
  step_normalize(all_predictors(), -all_nominal())
```

```{r}
# Deaths
workflow_tune_deaths <- workflow_set(
  
  preproc = list(
    kknn_deaths = kknn_deaths_rec,
    svm_poly_deaths = svm_deaths_rec,
    svm_rbf_deaths = svm_deaths_rec,
    dec_tree_deaths = dec_tree_deaths_rec,
    ranger_deaths = ranger_deaths_rec
  ),
  
  models = list(
    wf_1 = kknn_model,
    wf_2 = svm_poly_model,
    wf_3 = svm_rbf_model,
    wf_4 = dec_tree_model,
    wf_5 = ranger_model
  ), 
  
  cross = F
)


workflow_tune_confirmed <- workflow_set(
  
  preproc = list(
    kknn_confirmed = kknn_confirmed_rec,
    svm_poly_confirmed = svm_confirmed_rec,
    svm_rbf_confirmed = svm_confirmed_rec,
    dec_tree_confirmed = dec_tree_confirmed_rec,
    ranger_confirmed = ranger_confirmed_rec
  ),
  
  models = list(
    wf_1 = kknn_model,
    wf_2 = svm_poly_model,
    wf_3 = svm_rbf_model,
    wf_4 = dec_tree_model,
    wf_5 = ranger_model
  ), 
  
  cross = F
)
```

```{r}
cl <- makePSOCKcluster(8)
registerDoParallel(cl)

grid_ctrl <-
   control_grid(
      save_pred = TRUE,
      save_workflow = TRUE
   )

workflow_results_deaths <- workflow_tune_deaths %>%
  workflow_map(
    seed = 1503,
    resamples = spain_rolling_deaths,
    grid = 20,
    control = grid_ctrl,
    verbose = T
   )

stopCluster(cl)
```

```{r}
autoplot(workflow_results_deaths, select_best = T) +
  ggtitle("Results for the deaths model") +
  theme(plot.title = element_text(hjust = 0.5, size = 20)) +
  scale_color_tq() +
  theme_tq()

workflow_results_deaths %>%
  pull_workflow_set_result("dec_tree_deaths_wf_4") %>%
  collect_metrics()
```





```{r}
set.seed(51663)

cl <- makePSOCKcluster(8)
registerDoParallel(cl)

kknn_deaths_tune <-
  tune_grid(
    kknn_deaths_wflow, 
    resamples = spain_rolling_deaths, 
    grid = knn_deaths_grid,
    control = grid_ctrl
      )

kknn_confirmed_tune <-
  tune_grid(
    kknn_confirmed_wflow, 
    resamples = stop("add your rsample object"), 
    grid = stop("add number of candidate points"),
    control = 
      )

dec_tree_deaths_tune <-
  tune_grid(
    dec_tree_deaths_wflow, 
    resamples = spain_rolling_deaths, 
    grid = stop("add number of candidate points"),
    control = 
      )

dec_tree_confirmed_tune <-
  tune_grid(
    dec_tree_confirmed_wflow, 
    resamples = stop("add your rsample object"), 
    grid = stop("add number of candidate points"),
    control = 
      )

ranger_deaths_tune <-
  tune_grid(
    ranger_deaths_wflow, 
    resamples = spain_rolling_deaths, 
    grid = stop("add number of candidate points"),
    control = 
      )

ranger_confirmed_tune <-
  tune_grid(
    ranger_confirmed_wflow, 
    resamples = stop("add your rsample object"), 
    grid = stop("add number of candidate points"),
    control = 
      )

stopCluster(cl)
```

```{r}
cl <- makePSOCKcluster(8)
registerDoParallel(cl)

set.seed(51663)
knn_deaths_grid <- grid_max_entropy(parameters(kknn_model), 
                                    size = 50)
kknn_deaths_tune <-
  tune_grid(
    kknn_deaths_wflow, 
    resamples = spain_rolling_deaths, 
    grid = knn_deaths_grid,
    control = grid_ctrl
      )
stopCluster(cl)
```








# STACKING ENSEMBLE


# REFERENCES



